2017
01_GENNAIO
#17_01_23
Ciao Gabriele,
le info sull'argomento in oggetto le puoi recuperare googlando

arduino load cell hx711

perchè corrisponde al kit che ti porterò domani.
Il dispositivo in foto è basato su una singola cella di carico ma la meccanica
che permette di usarne una sola è un po' sofisticata. Come già detto se però
tu credi che la cella singola sia la soluzine giusta allora rivalutiamo il peso
economico della meccanica necessaria.

Ti porterò anche 4 celle di carico acquistate da aliexpress quindi dalle caratteristiche
poco dettagliate. Costano poco ma ... sono affidabili? ripetitive? la dispersione delle
caratteristiche tra i vari dispositivi è proibitiva? Compensabile?....
Le celle comprate sono queste

https://www.aliexpress.com/item/1PCS-DIY-50Kg-Body-Load-Cell-Weighing-Sensor-Resistance-strain-Half-bridge/32597969753.html?spm=2114.13010608.0.0.pC56uP


Per la connessione elettrica dei dispositivi non farti problemi a chiedere anche se
immagino potrà divertirti provare a fare da solo.

http://www.instructables.com/id/Make-your-weighing-scale-hack-using-arduino/

https://learn.sparkfun.com/tutorials/load-cell-amplifier-hx711-breakout-hookup-guide

https://learn.sparkfun.com/tutorials/load-cell-amplifier-hx711-breakout-hookup-guide/arduino-code

http://www.theorycircuit.com/interfacing-load-cell-arduino-using-hx711/



#17_01_27
Dopo tre ore di lavoro, installato correttamente IDE Ardino. Provato sul mio UNO, Blink funziona.

Montaggio secondo http://www.instructables.com/id/Make-your-weighing-scale-hack-using-arduino/




02_FEBBRAIO
#17_02_03

|  CELLE DI CARICO : Vcc = bianco  Vss = nero  signal = rosso
|  S+ -> A+    |  GND  -> GND    
|  S- -> A-    |  VCC  -> 5V
|  E+ -> E+    |  DT   -> A1
|  E- -> E-    |  SCK  -> A0 
|


Circuito montato: dubbio sui collegamenti delle celle di carico, provo intanto con Vcc collegato a Vss della successiva.
L'apparato funziona: il programma compila, gira e c'e' una reazione corrispondente (contemporanea) alla variazione di peso. Non mi e' molto chiaro come oscilli la misura: sembra cambiare un po' a casaccio; forse e' un problema di sensibilita'.
Provata lettura dal serial: https://chrisheydrick.com/2012/06/24/how-to-read-serial-data-from-an-arduino-in-linux-with-c-part-4/ fallito. Riprovero', per ora mi basta copincollare.

Qualche prova:
- un peso di 2kg viene letto con uno sbalzo a ~7kg, per poi scendere nel giro di 1-2 minuti a 3.
- scosse sul tavolo, anche non fortissime, sballano un po'
[[ ci vuole ~2min per l'assestamento ]]
- tolto il peso, scende lentamente a 1.1
- rimesso il peso, 4.5->3.6

Problema: far si' che la DEFORMAZIONE AVVENGA. Ho risolto con stuzzicadenti messi ai lati delle celle.
Problema del contatto: tutte le celle devono essere a contatto.
Sembra non essere sensibile a variazioni di 0.5kg.
Mettendo un kg, poi togliendolo, rimettendolo etc si osserva un andamento NON REGOLARE di salita-plateu-salita (dato ~1min per stabilizzarsi); le celle paiono non essere in grado di rilassarsi a 0. 
Dopo un urto la scala si setta a un valore diverso.
Con pesi piu' grandi (2kg) c'e' un rilassamento, ma irregolare.

Piano di lavoro:
- misure con aggiunta-rimozione di pesi e andamento temporale:
	- ci sono regolarita' nei delta di salita/discesa?
	- quanto tempo per stabilizzarsi?
	- quanto varia l'errore in funzione del peso?



#17_02_05
[[ mi assicuro che tutte le celle tocchino contemporaneamente]]
Problema: il peso sale indefinitamente senza che io faccia nulla... provo a rivedere i contatti. 
Ho collegato i minijack direttamente con giunzione ai cavi del ponte Wheatstone.
-> Misure migliori: 
   - piu' stabilita'
   - proporzionalita' segnale-peso
-> Sensibilita' ridottissima: 2kg -> 0.1 di delta

Lettura del codice: e' presente un fattore di scala, di 2280 di default. Modificandolo a 114 (= 2280/(2/0.1)) ci si avvicina a unita' sensate (2kg -> 1.6; 4kg-> 4.4), ma ci sono molte fluttuazioni.


#17_02_16
Prendo alcune serie di dati a peso costante. Bisognerebbe capire perche' funziona "a scalini".

Cosa succede se prendo i dati "raw"? Provo a non usare la funzione get_units() e uso invece read().
Le oscillazioni sono piu' chiare, ma si vede ugualmente la struttura a scalino (170216_002-fix_raw.dat)


#17_02_22
Root funzionante

#17_02_23
Ricerca info su internet:
http://www.cardinalscale.com/2013/load-cell-troubleshooting-101/ dice che e' un problema di "moisture", ma non credo sia il mio caso
-> negozio di elettronica   http://www.pinto.it/default.aspx   COMPRARE RESISTENZA DA ~250ohm, per cortocircuitare l'Arduino e controllare il segnale di input
Per migliorare l'acquisizione, in futuro: tenere solo dati che o sono simili al precedente o continuano a essere molto diversi (cioe' quando il peso cambia)
BISOGNA LEGGERE https://learn.sparkfun.com/tutorials/load-cell-amplifier-hx711-breakout-hookup-guide dove forse spiega il filo rosso delle celle

#17_02_27 e 28
Comprato multimetro.
Riassemblaggio con resistencome da Sparkfunsse come ponte di Wheatstone, ma [[shifting verso l'alto resta]].
Scoperto schematics al sito https://www.sparkfun.com/products/13878?_ga=1.186640489.1126097763.1485380550.

#17_03_01
Riassemblato come da Sparkfun, ma resta shifting (il problema sembra quindi essere nell'Arduino/nell'ampli!).
Prendo una misura per rendermi conto.
03_MARZO
04_APRILE
170424

tolto lo scale.power_down(), per mettere solo il .power_up() una volta per tutte
Risultati brutti quanto prima

dati 001 : condensatore elettrolitico parallelo all'alimentazione
risultati strani: lunghissimi plateau perfettamente stabili, con scoppi di plateau piu' alti [1]


170426

Controllato circuito: il problema [1] era evidentemente qualcosa montato male. Resta pero' la salita sistematica, ancora senza spiegazione

Accordata con Roberto sessione di "laboratorio", per:
- vedere con l'oscilloscopio se l'Arduino alimenta bene
- verificare che l'amplificatore funzioni come dovuto
- verificare che il metodo di acquisizoine da computer sia corretto
- verificare che il circuito sia montato bene
05_MAGGIO
170505

[X] Il circuito finalmente funziona: con Roberto il 3 ci siamo trovati per saldare tutto e ora e' decente.
Presi dati a 0.1 secondo: si nota shift verso l'alto di qualche 0.1


170524

Due prese dati: 
_ piu' di 24h di background, dt=100s
_ aggiunta-rimozione di pesi da 2kg, dt=1s
Il comportamento e' ottimo: si procede con una  \\prima taratura\\: 
    con "Serial.print(scale.get_units()*0.1 , 1);" a 4kg corrisponde 68.7
messo il numero di scala u  = .0058224 e funziona

\\Aggiungo cifre decimali\\: non piu' di 3 perche' non avrebbe senso, data la precisione di 0.1 desiderata; ma voglio vedere quanto e' stabile
Prima nota: i due pesi forse non sono esattamente 2+2kg: uso una bilancia elettronica per controllare: sono in realta' 3870g
=> \\ritaro\\ con u=.005600966442953021 (v*4.023=3.870; X*u_old*0.1=4.023)
Ora e' //preciso alla 2a cifra decimale!// quindi e' stata una buona scelta tenere la terza, ma non serve la quarta

Ora mi rendo conto che serve una misura di background di lunga durata con questa taratura! A questo punto avrebbe senso farla a vuoto e con un peso sopra, cosi' in una botta sola mi rendo conto se l'imprecisione cambia con lo stress delle celle.


170527

Finita la \\presa dati da 60 ore\\. La linea e' quasi piatta, sulla scala dei kg. In ogni caso, anche quando ci sono le oscillazioni piu' grandi e sistematiche, //su un periodo di due ore l'errore non sale sopra l'ordine dei 10g//.
Si vede piuttosto chiaramente che l'andamento del background e' somma di due andamenti: uno di rumore, casuale; l'altro sistematico, con una forma abbastanza riconoscibile.
Un fit effettuato con Root rende evidente che l'andamento e' //parabolico a tratti//, con un chi2 ridicolo (10^-6).

L'obiettivo diventa ora automatizzare un programma che riconosca queste strutture paraboliche a tratti, le sottragga al background totale e tiri fuori (sperabilmente) un rumore del tutto casuale.

NB: quando il peso aumentera', bisogna vedere con che velocita' lo fara', cioe' quanto influira' sul moto parabolico!

Ho trasformato in object-oriented il file plot.cxx, che ora diventa machine.cxx: funzione plot_file pronta


170531

Lavoro a machine.cxx
Funzione per ottenere la media.

Progetto per il fit_in_progress:
\\procedura transizione fit\\
tre iteratori: start, border, explorer
partono insieme. Explorer va avanti e misura la deviazione dal fit atteso. Quando e' buona, casuale, border lo segue; altrimenti si segna lo start-border per il primo fit, dopodiche' start va dov'e' border, explorer torna a start e si ricomincia
\\procedura creazione fit\\
explorer e border vanno avanti di 10
08_AGOSTO_2017
170630

Sto studiando l'uso di SD (dovrei esserci).
Problemi a usare la libreria HX711.h, probabilmente dovuti alla versione vecchia dell'IDE di Mint. Provo a installarlo da git.
L'IDE funziona. La libreria si e' caricata.
//PROBLEMA
pare che SD.begin() utilizzi i pin 11,12,13 e 10 (www.arduino.cc/en/Reference/SDbegin), gli stessi usati nella costruzione del circuito per collegare l'HX711!



2017_09_SETTEMBRE

170908
Ripresa: con Roberto dissaldati i pin per liberare i pin 10-13.
Proposta di usare scheda alternativa, con wifi: appena finita questa prova, se tutto va bene, transizione.
NUOVA CONFIGURAZIONE
  pin 10-13 lasciati liberi
  pin 7 -> SCK
  pin 8 -> DT
Pare funzionare: provo a lasciarlo qualche ora, collegato col caricatore del cellulare.

170921
Tutto andato bene: la presa dati ha senso.
Aggiunto DHT11, sensore termo+umidita', che Roberto mi ha fornito essendo il mio rotto per qualche ragione ignota (puzza di fumo): di nuovo qualche giorno di presa dati.
Analisi dei dati in arrivo: sono comunque stabili intorno a un valore 5.84-5.96 (delta di 0.120 che e' tanto, ma vedremo la media). Root fa le bizze (non si installa), quindi passo a qualcosa di piu' terra terra, ovvero Gnuplot+cplusplus.

to_plot.cxx passa da un documento del tipo
# aaa
# bbb
1 2 3 4 
5 6 7 8
9 1 2 3
a un documento del tipo
0 1 2 3 4
1 5 6 7 8
2 9 1 2 3
rendendolo quindi pronto per il plot.

Il plot provvisorio mostra che in 24h l'oscillazione del dato crudo e' intorno ai 10g, che con una running mean potrebbe ridursi di molto e rendere quindi abbastanza precisa la pesatura.





170926
Raccolta dati dopo qualche giorno di temperatura+peso fisso. Purtroppo avevo sbagliato a fare il programma, quindi i dati erano su un'unica riga: con rearrange.py ho messo un a capo ogni 17 caratteri e sembra avere senso, provo a plottare.
Molti dati sono da buttare: qualcosa e' caduto sulla bilancia... Comunque i pochi dati a disposizione mostrano un trend credibile temperatura-peso misurato. Ripetero'.


171010
Raccolta dati durata una settimana (fatta ripartire perche' ci avevano messo un casco di banane sopra...).
Inizio a fare analisi dati: rimetto in sesto machine.cxx, visto che ora root va; uso le TNtuple, scoprendo cose interessanti mentre cerco di farle funzionare
- si potrebbe fare un'analisi dati statistica guardando l'istogramma: c'e' un bel picco per il peso vero
Noto stranezze, guardo i dati: ci sono righe strambe e le sostituisco con 0 0 0

171011
I dati non mostrano un trend peso-temperatura molto netto.
Ho provato a lavorare sui massimi, ma questo richiede di migliorare la parte di medie. Un altro approccio puo' essere quello di guardare i trend (sempre sulle medie) delle derivate, per vedere se temperatura e peso hanno senso insieme.
PROSSIMI STEP:
- creare macro che 
    -- apra il file
    -- prenda i dati
    -- faccia le medie
    -- prepari i grafici delle medie
    -- trovi le derivate delle medie
    -- prepari i grafici delle derivate 
- confrontare derivate delle medie di temperatura-peso



171017
Ok, lavoriamo alla macro. NB dovro' normalizzare!
Ho risolto con comode TNtuple: ora il costruttore fa tutto e riempie le TNtuple, per
- dati puri
- derivata
- media
Parametri per il costruttore: file, unita', numero di punti per la media

171018
Tenendo conto solo dei dati prima/dopo il drop ~125, si notano correlazioni chiare tra temperatura e peso: Pesatura_Arnie/analisi_dati/171010_long_sd_temp/Weight:Temperature_timed_first.pdf e -second.pdf

Finita la presentazione per la riunione di domani.


171022
(Nei giorni scorsi e oggi)
Setup del NodeMCU per leggere temperatura e umidita', con trasferimento dati su ThingSpeak.
Ricostruzione del circuito con il NodeMCU, con anche le celle.
Problema: SOFT WDT RESET. Internet parla di resistenze da mettere sul VCC, ma anche di problemi di delay. Sta di fatto che pare risolto con un piccolo delay trale acquisizioni iniziali dall'HX711.
Ora faro' partire tutto e vediamo.


171102
Un po' indietro con gli aggiornamenti.
Dopo la presentazione del progetto a Re.Te., e' stato proposto di usarlo all'inaugurazione dell'Arsenale della Terra, il 16 novembre. Per quella data, Roberto preparera' la base (gia' pronta) e un pannello solare (!), mentre io mi occupero' di collegarci i sensori e predisporre i dati su ThingSpeak.
Al momento, due questioni:
1 - URGENTE: far funzionare i NodeMCU, che dopo il cambio di dispositivo fanno le bizze (software)
2 - analisi dati implementata su NodeMCU

171104
Punto 1 non risolto neanche reinstallando l'IDE. Mentre ci penso, provo a implementare l'analisi dati in una funzione di root.

171105
Punto 2: il programma funziona, ma non fa quello che mi aspettavo: peggiora la pendenza. 


171107
punto 2: il programma funziona! Ancora TODO la sigma, da migliorare
cfr. analisi_dati/171010_long_sd_temp/Weight_clean_with_T.pdf

171112
Le soddisfazioni del lato analisi dati sono compensate dalla frustrazione del lato hardware:
il NodeMCU con la libreria Wifi non funziona niente bene, o meglio un po' funziona, un po' no, a seconda di quali linee commento!
Scrivo un thread su http://www.esp8266.com, sperando di avere qualche risposta...

171114
Provo a sostituire il porting del NodeMCU:
da http://arduino.esp8266.com/stable/package_esp8266com_index.json
a http://arduino.esp8266.com/versions/2.3.0/package_esp8266com_index.json
(suggerimento dal forum, di Narfel)
In ogni caso NON FUNZIONA, non era quello il problema. Ma e' stato utile: mi ha ricordato di escludere le librerie del DHT11 e del HX711.
Non resta che imparare il Lua... 

Mentre scrivo la mail a Roberto, mi rendo conto che ho usato la SECONDA ESP... la PRIMA SEMBRA FUNZIONARE!
Dissaldo e risaldo tutto...
Niente, non va uguale. Gah.

171115
Alla fine c'erano due soluzioni:
_ Roberto mi dice: 
  while (WiFi.localIP().toString() == "0.0.0.0") 
_ https://stackoverflow.com/questions/43354086/nodemcu-esp8266-connecting-to-iphone-hotspot-with-c mi dice:
  WiFi.mode(WIFI_STA);
  while (WiFi.status() != WL_CONNECTED)

Risaldato sull'impalcatura per il pannello solare. Problemi nuovi: Soft WTD reset. Ci pensero'. Almeno senza pannello ora lavora.

171121
Dopo qualche giorno di problemi, ho finito di rivedere software e hardware.
- il software aveva probabilmente qualche buggino, l'ho tolto copincollando di nuovo tutti i pezzi, dopo aver controllato che funzionassero
- hardware: il 5V della shield non connetteva con le prese a vite, ho risolto facendo un "bypass" esterno; le prese a vite etichettate D1,D2,D3 sono in realta' D0,D1,D2, e' bastato rinominare tutto nei file .ino
ORA FUNZIONA. Speriamo continui a farlo.

171123
Funziona. Quello: invece il low-power no. 
Se collego RST e D0 (tra l'altro, ora dovro' cambiare il link a D0, che serve per questo) il Node si resetta, punto. Invece dovrebbe farlo solo quando il comando glielo dice.
Roberto mi ha mandato una mail con il suggerimento di staccarlo dal cavo, mentre funziona. Quindi devo caricare la batteria, il che richiedera' tempo; intanto cerco ancora un po' su internet.
# https://www.reddit.com/r/esp8266/comments/4p9012/nodemcu_board_sleep_tying_d0_and_rst_constantly/ dice di mettere D0 su HIGH, cosa che ho gia' provato ieri; ma non funziona ugualmente, dopo il primo reset setup() non viene chiamato.
Mistero dei misteri, all'indirizzo http://www.esp8266.com/viewtopic.php?f=6&t=10524&sid=cc835d1021aef84ffce347bf946f5fcb&start=8 c'e' un codice che FUNZIONA. E non so perche'. Poche domande, va'. E' just_sleep_bbx10node


171124
INCREDIBILMENTE funziona: HX711_DHT11_wifi_low.ino
C'e' la presa dati, ThingSpeak e il esp.deepSleep
### TODO ###
Quando c'e' il reset, la tara si ritara (appunto), quindi va trovato un modo di storare la tara precedente  -->> si potrebbe cogliere l'occasione per risolvere (forse) anche il problema degli sbalzi di tara, ritarando ogni tot, ma sapendo quanto deve venire


180303
Anche se è passato tempo, non sono stato con le mani in mano:
- il prototipo con low battery funziona
- il pannello solare funziona, ma non abbastanza -> devo fare misure di carica/scarica
- contatto con Giampaolo Mancini
- prototipo dato a Rinaldo in attesa di montaggio e feedback

Parlando di # MISURE DI CARICA # della batteria, mi sembra di aver capito che:
- misurare il voltaggio della batteria dà un'indicazione della carica (https://www.powerstream.com/1922/battery_1922_WITTE/batteryfiles/chapter05.htm)
- non dà problemi misurare la carica della batteria con cui alimento l'Arduino (https://forum.arduino.cc/index.php?topic=92074.0)
Segue che basta collegare il - a ground, il + a A0 e misurare con analogRead(0) il voltaggio, con le seguenti accortezze:
- settare il riferimento a 1.1V interno ad arduino con analogReference(INTERNAL) (https://forum.arduino.cc/index.php?topic=92074.15)
- limitare il voltaggio per non rompere Arduino
[ per due pile da 1.5V in serie = 3V, assumendo una corrente dell'ordine dei mA,la caduta di potenziale potrebbe essere tranquillamente di 2V -> 1V all'Arduino; per la legge di Ohm R=2kOhm. 
Dubbio: devo metterlo sia su - sia su + ? ]
Quindi:
  ¤ GND -> resistenza -> - della batteria
  ¤ A0  -> resistenza -> + della batteria
  ¤ alimentazione qualunque
  ¤ analogReference(INTERNAL) e analogRead(0)
Poi ci sarà da regolare i dati per avere il voltaggio esatto, ma non è di primario interesse dato che ci interessa la percentuale e la forma della scarica.

180405
In realtà lo schema deve essere diverso, come mi ha scritto Roberto:
gnd-R2-battnegativo
A0-R1-R2
R1-battpositivo
e leggo da A0
